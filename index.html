<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Access Professional Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { 
            background-color: #0b1120; 
            color: #e2e8f0; 
            font-family: 'Plus Jakarta Sans', sans-serif; 
        }
        
        /* Glassmorphism Utilities */
        .glass {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .glass-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.6) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .glass-input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0b1120; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Animation */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: fade-in 0.4s ease-out forwards; }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#6366f1',
                        dark: '#0b1120',
                        surface: '#1e293b'
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- FIREBASE CONFIGURATION ---
        // REPLACE THIS WITH YOUR OWN CONFIG IF NEEDED
        const firebaseConfig = {
            apiKey: "AIzaSyBx5fYrM_mVwn9pfgf5fjSxRIOvB8ViTko",
            authDomain: "esp-test-ff3e3.firebaseapp.com",
            databaseURL: "https://esp-test-ff3e3-default-rtdb.firebaseio.com",
            projectId: "esp-test-ff3e3",
            storageBucket: "esp-test-ff3e3.firebasestorage.app",
            messagingSenderId: "431926409160",
            appId: "1:431926409160:web:534274240d408acecbf2fd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // --- UTILITIES ---
        const formatTime = (timestamp) => {
            if (!timestamp) return "Unknown";
            // Check if timestamp is likely seconds (Arduino Epoch) or Milliseconds
            let date;
            // If it looks like a number string
            if (!isNaN(timestamp)) {
                const ts = Number(timestamp);
                // If timestamp is roughly in year 2020-2030 in seconds (10 digits), multiply by 1000
                date = new Date(ts < 10000000000 ? ts * 1000 : ts);
            } else {
                date = new Date(timestamp);
            }
            
            if (date.toString() === 'Invalid Date') return timestamp;
            
            return date.toLocaleString('en-US', {
                month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        };

        // --- COMPONENTS ---

        const Login = () => {
            const [isRegistering, setIsRegistering] = React.useState(false);
            const [email, setEmail] = React.useState("");
            const [password, setPassword] = React.useState("");
            const [error, setError] = React.useState("");
            const [loading, setLoading] = React.useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError("");
                setLoading(true);
                try {
                    if (isRegistering) {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    setError(err.message.replace('Firebase: ', ''));
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-[#0b1120] p-4 relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-full h-full overflow-hidden z-0">
                        <div className="absolute top-[-20%] left-[-10%] w-[600px] h-[600px] bg-blue-600/10 rounded-full blur-[120px]"></div>
                        <div className="absolute bottom-[-20%] right-[-10%] w-[500px] h-[500px] bg-indigo-600/10 rounded-full blur-[120px]"></div>
                    </div>

                    <div className="glass-card p-8 rounded-2xl w-full max-w-md relative z-10 animate-enter">
                        <div className="text-center mb-8">
                            <div className="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-tr from-blue-500 to-indigo-600 shadow-lg shadow-blue-500/20 text-white mb-4">
                                <i className="ph-fill ph-house-line text-3xl"></i>
                            </div>
                            <h2 className="text-2xl font-bold text-white tracking-tight">Smart Access</h2>
                            <p className="text-slate-400 text-sm mt-1">Authentication Required</p>
                        </div>

                        {error && (
                            <div className="bg-red-500/10 border border-red-500/20 text-red-400 p-3 rounded-xl mb-6 text-sm flex items-center gap-2">
                                <i className="ph-bold ph-warning-circle"></i> {error}
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-5">
                            <div>
                                <label className="block text-xs font-semibold uppercase tracking-wider text-slate-500 mb-1.5 ml-1">Email Address</label>
                                <div className="relative">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i className="ph-bold ph-envelope text-slate-500"></i>
                                    </div>
                                    <input 
                                        type="email" 
                                        required
                                        className="w-full glass-input rounded-xl pl-10 pr-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all"
                                        placeholder="admin@iot.com"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-semibold uppercase tracking-wider text-slate-500 mb-1.5 ml-1">Password</label>
                                <div className="relative">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i className="ph-bold ph-lock text-slate-500"></i>
                                    </div>
                                    <input 
                                        type="password" 
                                        required
                                        className="w-full glass-input rounded-xl pl-10 pr-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all"
                                        placeholder="••••••••"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                    />
                                </div>
                            </div>
                            <button 
                                type="submit" 
                                disabled={loading}
                                className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-semibold py-3.5 rounded-xl shadow-lg shadow-blue-600/20 transition-all transform hover:scale-[1.01] active:scale-[0.99] disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {loading ? (
                                    <span className="flex items-center justify-center gap-2">
                                        <i className="ph-bold ph-spinner animate-spin"></i> Processing
                                    </span>
                                ) : (isRegistering ? 'Create Account' : 'Sign In Dashboard')}
                            </button>
                        </form>

                        <div className="mt-6 text-center">
                            <button 
                                onClick={() => setIsRegistering(!isRegistering)}
                                className="text-sm text-slate-400 hover:text-white transition-colors"
                            >
                                {isRegistering ? 'Already have an account? Sign In' : 'New user? Create Account'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ControlCard = ({ label, icon, isActive, onClick, activeColor }) => (
            <div 
                onClick={onClick}
                className={`group relative overflow-hidden rounded-2xl p-6 cursor-pointer transition-all duration-300 border ${isActive ? 'bg-slate-800/80 border-slate-600' : 'glass-card border-slate-700/30 hover:border-slate-600'}`}
            >
                <div className={`absolute top-0 right-0 p-4 transition-transform duration-300 ${isActive ? 'rotate-12 scale-110' : 'scale-100'}`}>
                    <div className={`w-3 h-3 rounded-full ${isActive ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.6)]' : 'bg-slate-600'}`}></div>
                </div>
                
                <div className="flex flex-col h-full justify-between relative z-10">
                    <div className={`w-12 h-12 rounded-xl flex items-center justify-center text-2xl mb-4 transition-colors duration-300 ${isActive ? activeColor : 'bg-slate-700/50 text-slate-400'}`}>
                        <i className={`ph-fill ${icon}`}></i>
                    </div>
                    
                    <div>
                        <h3 className="font-semibold text-lg text-white mb-1">{label}</h3>
                        <div className="flex items-center justify-between">
                            <span className={`text-sm font-medium ${isActive ? 'text-white' : 'text-slate-500'}`}>
                                {isActive ? 'Running' : 'Stopped'}
                            </span>
                            <div className={`w-10 h-5 rounded-full relative transition-colors duration-300 ${isActive ? 'bg-blue-600' : 'bg-slate-700'}`}>
                                <div className={`absolute top-1 left-1 w-3 h-3 bg-white rounded-full transition-transform duration-300 ${isActive ? 'translate-x-5' : 'translate-x-0'}`}></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {/* Background Glow */}
                {isActive && <div className="absolute -bottom-10 -right-10 w-32 h-32 bg-blue-500/10 rounded-full blur-[40px]"></div>}
            </div>
        );

        const Dashboard = ({ user }) => {
            const [data, setData] = React.useState({
                fan: 0,
                light: 0,
                temperature: 0.0,
                attendance: []
            });
            const [connected, setConnected] = React.useState(false);
            const [currentTime, setCurrentTime] = React.useState(new Date());

            React.useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                
                const connectedRef = ref(db, ".info/connected");
                onValue(connectedRef, (snap) => setConnected(!!snap.val()));

                // Fetch Controls
                onValue(ref(db, 'controls'), (snap) => {
                    const val = snap.val() || {};
                    setData(d => ({ ...d, fan: Number(val.fan || 0), light: Number(val.light || 0) }));
                });

                // Fetch Temp
                onValue(ref(db, 'temperature'), (snap) => {
                    setData(d => ({ ...d, temperature: Number(snap.val() || 0) }));
                });

                // Fetch Attendance
                onValue(ref(db, 'attendance'), (snap) => {
                    const val = snap.val();
                    let formatted = [];
                    if (val) {
                        // Handle different data structures (Array vs Object map)
                        formatted = Object.entries(val).map(([key, value]) => {
                            // If structure is { "timestamp": "Name" }
                            if (typeof value === 'string') return { id: key, timestamp: key, name: value };
                            // If structure is { "id": { name: "Name", time: "..." } }
                            return { id: key, timestamp: value.time || key, name: value.name || "Unknown" };
                        });
                        // Sort by timestamp descending
                        formatted.sort((a, b) => {
                            // Basic string comparison works for ISO dates, but number comparison for Epoch
                            const timeA = isNaN(a.timestamp) ? new Date(a.timestamp).getTime() : Number(a.timestamp);
                            const timeB = isNaN(b.timestamp) ? new Date(b.timestamp).getTime() : Number(b.timestamp);
                            return timeB - timeA; 
                        });
                    }
                    setData(d => ({ ...d, attendance: formatted }));
                });

                return () => clearInterval(timer);
            }, []);

            const toggleDevice = (device, currentVal) => {
                // FORCE INTEGER 0 or 1 for Arduino compatibility
                const newVal = currentVal === 1 ? 0 : 1;
                set(ref(db, `controls/${device}`), newVal)
                    .catch(err => alert("Error: " + err.message));
            };

            const getGreeting = () => {
                const hour = currentTime.getHours();
                if (hour < 12) return "Good Morning";
                if (hour < 18) return "Good Afternoon";
                return "Good Evening";
            };

            return (
                <div className="flex min-h-screen bg-[#0b1120]">
                    
                    {/* Sidebar (Desktop) */}
                    <aside className="hidden md:flex w-64 flex-col border-r border-slate-800 bg-[#0f172a]/50 backdrop-blur-xl fixed h-full z-20">
                        <div className="p-6">
                            <div className="flex items-center gap-3 text-white mb-8">
                                <div className="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center">
                                    <i className="ph-bold ph-circles-three text-xl"></i>
                                </div>
                                <span className="font-bold text-lg tracking-tight">IoT Admin</span>
                            </div>
                            
                            <nav className="space-y-1">
                                <a href="#" className="flex items-center gap-3 px-4 py-3 bg-blue-600/10 text-blue-400 rounded-xl font-medium border border-blue-600/10">
                                    <i className="ph-fill ph-squares-four text-lg"></i>
                                    Dashboard
                                </a>
                                <div className="pt-4 pb-2 px-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Account</div>
                                <button onClick={() => signOut(auth)} className="w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-xl font-medium transition-colors text-left">
                                    <i className="ph-bold ph-sign-out text-lg"></i>
                                    Sign Out
                                </button>
                            </nav>
                        </div>
                        
                        <div className="mt-auto p-6">
                            <div className={`flex items-center gap-3 px-4 py-3 rounded-xl border ${connected ? 'bg-emerald-500/5 border-emerald-500/20' : 'bg-red-500/5 border-red-500/20'}`}>
                                <span className={`relative flex h-2.5 w-2.5`}>
                                  <span className={`animate-ping absolute inline-flex h-full w-full rounded-full opacity-75 ${connected ? 'bg-emerald-500' : 'bg-red-500'}`}></span>
                                  <span className={`relative inline-flex rounded-full h-2.5 w-2.5 ${connected ? 'bg-emerald-500' : 'bg-red-500'}`}></span>
                                </span>
                                <div className="flex flex-col">
                                    <span className={`text-xs font-bold ${connected ? 'text-emerald-400' : 'text-red-400'}`}>
                                        {connected ? 'System Online' : 'Disconnected'}
                                    </span>
                                    <span className="text-[10px] text-slate-500">Realtime Sync</span>
                                </div>
                            </div>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 md:ml-64 p-4 md:p-8 overflow-y-auto">
                        
                        {/* Header */}
                        <header className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4 animate-enter">
                            <div>
                                <h1 className="text-3xl font-bold text-white mb-1">{getGreeting()}, Admin</h1>
                                <p className="text-slate-400 flex items-center gap-2 text-sm">
                                    <i className="ph-fill ph-calendar-blank text-blue-500"></i>
                                    {currentTime.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}
                                </p>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="hidden md:block text-right">
                                    <div className="text-2xl font-mono font-bold text-white tracking-wider">
                                        {currentTime.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' })}
                                    </div>
                                    <div className="text-xs text-slate-500 uppercase tracking-widest font-semibold">System Time</div>
                                </div>
                                <div className="md:hidden">
                                    <button onClick={() => signOut(auth)} className="bg-slate-800 p-2 rounded-lg text-slate-300">
                                        <i className="ph-bold ph-sign-out text-xl"></i>
                                    </button>
                                </div>
                            </div>
                        </header>

                        {/* Controls Grid */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 animate-enter" style={{animationDelay: '0.1s'}}>
                            
                            {/* Temperature Widget */}
                            <div className="glass-card rounded-2xl p-6 relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-3">
                                    <i className="ph-fill ph-thermometer-simple text-slate-600 text-6xl opacity-20"></i>
                                </div>
                                <h3 className="text-slate-400 font-medium text-sm uppercase tracking-wider mb-4">Room Temperature</h3>
                                <div className="flex items-baseline gap-2">
                                    <span className="text-5xl font-bold text-white">{data.temperature.toFixed(1)}</span>
                                    <span className="text-xl text-slate-500">°C</span>
                                </div>
                                
                                <div className="mt-6">
                                    <div className="h-2 w-full bg-slate-700 rounded-full overflow-hidden">
                                        <div 
                                            className={`h-full rounded-full transition-all duration-1000 ${data.temperature > 30 ? 'bg-red-500' : 'bg-blue-500'}`} 
                                            style={{ width: `${Math.min((data.temperature / 50) * 100, 100)}%` }}
                                        ></div>
                                    </div>
                                    <div className="flex justify-between mt-2 text-xs text-slate-500 font-mono">
                                        <span>0°C</span>
                                        <span>25°C</span>
                                        <span>50°C</span>
                                    </div>
                                </div>
                                <p className="text-xs text-slate-500 mt-4 border-t border-slate-700/50 pt-3">
                                    <i className="ph-bold ph-info text-blue-500 mr-1"></i>
                                    Fan auto-triggers at > 25°C
                                </p>
                            </div>

                            {/* Light Control */}
                            <ControlCard 
                                label="Main Lights" 
                                icon="ph-lightbulb" 
                                isActive={data.light === 1} 
                                onClick={() => toggleDevice('light', data.light)}
                                activeColor="bg-amber-400 text-amber-900"
                            />

                            {/* Fan Control */}
                            <ControlCard 
                                label="Ventilation Fan" 
                                icon="ph-fan" 
                                isActive={data.fan === 1} 
                                onClick={() => toggleDevice('fan', data.fan)}
                                activeColor="bg-cyan-400 text-cyan-900"
                            />
                        </div>

                        {/* Attendance Section */}
                        <div className="glass-card rounded-2xl overflow-hidden animate-enter" style={{animationDelay: '0.2s'}}>
                            <div className="p-6 border-b border-slate-700/50 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                <div>
                                    <h3 className="text-lg font-bold text-white">Access Logs</h3>
                                    <p className="text-slate-400 text-sm">Real-time RFID entry tracking</p>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className="px-3 py-1 rounded-full bg-slate-800 text-slate-400 text-xs font-mono border border-slate-700">
                                        Total: {data.attendance.length}
                                    </span>
                                </div>
                            </div>
                            
                            <div className="overflow-x-auto">
                                <table className="w-full text-left border-collapse">
                                    <thead>
                                        <tr className="bg-slate-800/50 text-xs uppercase text-slate-400 font-semibold tracking-wider">
                                            <th className="px-6 py-4">User</th>
                                            <th className="px-6 py-4">Date & Time</th>
                                            <th className="px-6 py-4">Access Status</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-700/30">
                                        {data.attendance.length === 0 ? (
                                            <tr>
                                                <td colSpan="3" className="px-6 py-12 text-center text-slate-500">
                                                    <i className="ph-duotone ph-ghost text-4xl mb-2 inline-block"></i>
                                                    <p>No attendance records found yet.</p>
                                                </td>
                                            </tr>
                                        ) : (
                                            data.attendance.map((record, index) => (
                                                <tr key={index} className="hover:bg-slate-700/20 transition-colors group">
                                                    <td className="px-6 py-4">
                                                        <div className="flex items-center gap-3">
                                                            <div className="w-9 h-9 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-sm font-bold shadow-lg shadow-indigo-500/20">
                                                                {record.name.charAt(0).toUpperCase()}
                                                            </div>
                                                            <span className="font-medium text-slate-200 group-hover:text-white transition-colors">{record.name}</span>
                                                        </div>
                                                    </td>
                                                    <td className="px-6 py-4 text-slate-400 text-sm font-mono">
                                                        {formatTime(record.timestamp)}
                                                    </td>
                                                    <td className="px-6 py-4">
                                                        <span className="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">
                                                            <span className="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
                                                            Authorized
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <footer className="mt-8 text-center text-slate-600 text-xs">
                            <p>IoT Dashboard System v2.0 • Powered by React & Firebase</p>
                        </footer>

                    </main>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if (loading) {
                return (
                    <div className="min-h-screen bg-[#0b1120] flex items-center justify-center">
                        <div className="flex flex-col items-center gap-4">
                            <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                            <span className="text-slate-500 font-medium animate-pulse">Initializing System...</span>
                        </div>
                    </div>
                );
            }

            return user ? <Dashboard user={user} /> : <Login />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
